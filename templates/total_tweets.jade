html
  head
    title Total tweets
    style(type='text/css').
      /*
      input {
      float: left;
      clear: both;
      }
      */
    script(src='http://code.jquery.com/jquery-latest.js')
    script(type='text/javascript').

      var getPage = new RegExp( /page=([^&]+)/ );
      var url = "http://search.twitter.com/search.json?q=";
      var search, page, pageTotal, tweets, loading;
      var beforeCounter = "<b>";
      var afterCounter = "</b>";
      var totalTweets = 0;

      function getTweets(search, page, pageTotal) {
        $.getJSON( url + search + '&page=' + page + '&callback=?',
          function(data) {
            if( data.results.length !== 0 && page !== pageTotal ) {
              $('#pagesDone span').html(page);
              getData(data);
            }
            else {
              showTotal();
            }
          });
      }

      function showTotal() {
        $('#totalTweets span').html(beforeCounter + totalTweets + afterCounter);
        $('#pagesDone span').html('0');
        totalTweets = 0;
        loading = false;
      }

      function getData(data) {
        tweets = data.results;
        totalTweets += tweets.length;
        nextPage = getPage.exec(data.next_page);
        if( nextPage === null ) {
          showTotal();
          return;
        }
        nextPage = nextPage[1];
        getTweets(search, nextPage, pageTotal);
      }

      function submitTerms() {
        $('#totalTweets span').html('');
        $('#pagesDone span').html('0');
        search = encodeURIComponent($('#query').prop('value'));
        page = $('#startPage').prop('value');
        pageTotal = $('#pageTotal').prop('value');
        if( search === '' ) {
          alert('Please enter search query');
          return;
        }
        if( page === 0 ) {
          alert('0 not allowed as start page');
          return;
        }
        loading = true;
        getTweets(search, page, pageTotal);
      }

      function status() {
        if( loading ) $('#loading,#pagesDone').show();
        else $('#loading,#pagesDone').hide();
      }

      $(function() {
        loading = false;
        setInterval(status, 10);
      });
  body
    h1 Get your twitter counts here!
    form(action='', method='get', onsubmit='submitTerms(); return false;')
      label(for='query') Search for:
      input#query(name='query', type='text')
      br
      label(for='startPage') Start on what page (must be greater than 1)
      input#startPage(name='startPage', type='text', value='1')
      br
      label(for='pageTotal') How many pages (0 to search until no more results)
      input#pageTotal(name='pageTotal', type='text', value='0')
      input#submit(name='submit', type='submit', value='Go')
      span or press enter
    #totalTweets
      | Total tweets:
      span
    br
    #loading(style='display:none;') Loading!
    #pagesDone(style='display:none;')
      | Pages done:
      span
    span(style='display:none;') Do Electric Cars Pollute More Than Their Gasoline Counterparts
